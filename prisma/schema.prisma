datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==========================
//  ENUMS
// ==========================

enum role {
  CLIENT
  SUPPLIER
  ADMIN
}

enum delivery_type {
  DELIVERY
  PICKUP
}

enum status {
  PENDING
  ACCEPTED
  IN_TRANSIT
  DELIVERED
  PICKED_UP
  CANCELLED
}

enum AlertType {
  LEAK
  HIGH_CONSUMPTION
  SENSOR_OFFLINE
}

enum ConsumptionEventType {
  SIGNIFICANT_DROP
  LOW_LEVEL
  CRITICAL_LEVEL
  CYLINDER_REPLACED
  DAILY_BASELINE
}

enum NotificationChannel {
  WHATSAPP
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

// ==========================
//  USER
// ==========================

model user {
  user_id     String    @id @default(uuid())
  role        role
  name        String?
  phone       String    @unique
  email       String?
  is_verified Boolean   @default(false)
  has_sensor  Boolean   @default(false)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  deleted_at  DateTime?

  // Relations
  addresses           address[]
  consumption_event   consumption_event[]
  cylinder_change     cylinder_change[]
  alerts              alert[]
  orders_as_client    order[]              @relation("client_orders")
  orders_as_supplier  order[]              @relation("supplier_orders")
  supplier_info       supplier_info?
  consumption_current consumption_current?
  consumption_hourly  consumption_hourly[]
  consumption_daily   consumption_daily[]
  notifications       notification[]
  device_tokens       device_token[]

  @@index([phone])
}

// ==========================
//  OTP CODE
// ==========================

model otp_code {
  id         String   @id @default(uuid())
  phone      String   @unique
  otp_code   String
  expires_at DateTime
  created_at DateTime @default(now())
}

// ==========================
//  ADDRESS
// ==========================

model address {
  address_id   String   @id @default(uuid())
  user_id      String
  street       String
  number       String
  neighborhood String
  city         String
  state        String
  zip_code     String
  latitude     Decimal?
  longitude    Decimal?
  label        String?
  is_default   Boolean  @default(false)
  created_at   DateTime @default(now())

  // Relations
  user   user    @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  orders order[]
}


model consumption_event {
  id         String               @id @default(uuid())
  user_id    String
  weight_kg  Float
  percent    Float?
  event      ConsumptionEventType
  created_at DateTime             @default(now())

  user user @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}

model consumption_current {
  id         Int      @id @default(autoincrement())
  user_id    String   @unique
  weight_kg  Float
  percent    Float
  updated_at DateTime @updatedAt

  user user @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}

model consumption_hourly {
  id      Int      @id @default(autoincrement())
  user_id String
  hour    DateTime
  used_kg Float

  user user @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, hour])
  @@index([user_id, hour])
}

model consumption_daily {
  id      Int      @id @default(autoincrement())
  user_id String
  day     DateTime
  used_kg Float

  user user @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, day])
  @@index([user_id, day])
}

// ==========================
//  CYLINDER CHANGE
// ==========================

model cylinder_change {
  id         String   @id @default(uuid())
  user_id    String
  created_at DateTime @default(now())

  user user @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}

// ==========================
//  ORDER
// ==========================

model order {
  order_id      String        @id @default(uuid())
  client_id     String
  supplier_id   String
  address_id    String?
  delivery_type delivery_type
  status        status
  notes         String?
  price         Decimal?      @db.Decimal(10, 2)
  created_at    DateTime      @default(now())
  updated_at    DateTime      @updatedAt
  delivered_at  DateTime?

  // Relations
  client   user     @relation("client_orders", fields: [client_id], references: [user_id], onDelete: Restrict)
  supplier user     @relation("supplier_orders", fields: [supplier_id], references: [user_id], onDelete: Restrict)
  address  address? @relation(fields: [address_id], references: [address_id])

  @@index([client_id])
  @@index([supplier_id])
  @@index([address_id])
}

// ==========================
//  ALERT
// ==========================

model alert {
  alert_id   String    @id @default(uuid())
  user_id    String
  type       AlertType
  message    String
  handled    Boolean   @default(false)
  created_at DateTime  @default(now())
  metadata   Json?

  user user @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}

// ==========================
//  SUPPLIER INFO
// ==========================

model supplier_info {
  su_info_id      String   @id @default(uuid())
  user_id         String   @unique
  payment_methods Json?
  open_time       String?
  close_time      String?
  open_days       Json?
  is_active       Boolean  @default(true)
  deliveryTimes   Int?
  created_at      DateTime @default(now())

  user user @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

model notification {
  notification_id String              @id @default(uuid())
  user_id         String
  channel         NotificationChannel
  template        String?
  title           String?
  message         String
  payload         Json?
  status          NotificationStatus  @default(PENDING)
  provider        String? // "mock", "z-api", "twilio", "fcm"
  external_id     String?
  error           String?
  created_at      DateTime            @default(now())
  sent_at         DateTime?

  user user @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([status])
  @@index([channel])
}

model device_token {
  device_token_id String    @id @default(uuid())
  user_id         String
  token           String    @unique
  platform        String // "android" | "ios" | "web"
  enabled         Boolean   @default(true)
  created_at      DateTime  @default(now())
  last_seen_at    DateTime?

  user user @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}
